#define CKB_VM_ASM_GENERATE_LABEL_TABLES 1
#include "cdefinitions_generated.h"

#define ERROR_UNIMPLEMENTED 100

#define UNIMPLEMENTED \
  mov x0, ERROR_UNIMPLEMENTED; \
  b .exit

#define DECODE_U

#define MACHINE x0

#define TEMP1 x8
#define TEMP2 x9
#define TEMP3 x10
#define TEMP3w w10
#define TEMP4 x11
#define TEMP5 x12
#define TRACE x13
#define INST_PC x14
#define INST_ARGS x15

#define RD_RS2s x16
#define RD RD_RS2s
#define RS1 x17
#define RS2 x18
#define RS3 x19
#define IMMEDIATE x20
#define FLAG x21

#define REGISTER_BASE x22
#define ZERO_VALUE x23

#define REGISTER_ADDRESS(r) [REGISTER_BASE, r, lsl 3]
#define ZERO_ADDRESS [REGISTER_BASE]

#define WRITE_RD(v) \
  str v, REGISTER_ADDRESS(RD); \
  str ZERO_VALUE, ZERO_ADDRESS

#define NEXT_INST \
  ldr TEMP1, [INST_ARGS]; \
  add INST_ARGS, INST_ARGS, 8; \
  ubfx RD_RS2s, TEMP1, 8, 8; \
  asr TEMP1, TEMP1, 24; \
  ubfx FLAG, TEMP1, 0, 8; \
  asr TEMP1, TEMP1, 8; \
  ldr x9, [INST_PC]; \
  add INST_PC, INST_PC, 8; \
  br x9

#define DECODE_I \
  ubfx RS1, TEMP1, 0, 8; \
  asr IMMEDIATE, TEMP1, 8

.p2align 3
#ifdef __APPLE__
.globl _ckb_vm_x64_execute
_ckb_vm_x64_execute:
#else
.globl ckb_vm_x64_execute
ckb_vm_x64_execute:
#endif
  stp x19, x20, [sp, -48]!
  stp x21, x22, [sp, 16]
  stp x23, x24, [sp, 32]
  add REGISTER_BASE, MACHINE, CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_REGISTERS
  mov ZERO_VALUE, 0

.CKB_VM_ASM_LABEL_OP_CUSTOM_TRACE_END:
.prepare_trace:
  ldr TEMP2, [MACHINE, CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_PC]
  mov TEMP3, TEMP2
  lsr TEMP2, TEMP2, 5
  and TEMP2, TEMP2, 8191
  mov TEMP1, CKB_VM_ASM_TRACE_STRUCT_SIZE
  mul TEMP2, TEMP2, TEMP1
  add TRACE, MACHINE, TEMP2
  ldr TEMP1, =CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_TRACES
  add TRACE, TRACE, TEMP1
  ldr TEMP4, [TRACE, CKB_VM_ASM_TRACE_OFFSET_ADDRESS]
  cmp TEMP4, TEMP3
  bne .exit_trace
  ldrb TEMP3w, [TRACE, CKB_VM_ASM_TRACE_OFFSET_LENGTH]
  cmp TEMP4, 0
  beq .exit_trace
  ldr TEMP2, [MACHINE, CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_CYCLES]
  ldr TEMP1, [TRACE, CKB_VM_ASM_TRACE_OFFSET_CYCLES]
  add TEMP2, TEMP2, TEMP1
  bvs .exit_cycles_overflow
  ldr TEMP1, [MACHINE, CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_MAX_CYCLES]
  cmp TEMP2, TEMP1
  bhi .exit_max_cycles_exceeded
  str TEMP2, [MACHINE, CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_CYCLES]
  add TEMP3, TEMP3, TEMP4
  str TEMP3, [MACHINE, CKB_VM_ASM_ASM_CORE_MACHINE_OFFSET_PC]
  add INST_ARGS, TRACE, CKB_VM_ASM_TRACE_OFFSET_INSTRUCTIONS
  add INST_PC, TRACE, CKB_VM_ASM_TRACE_OFFSET_THREAD
  NEXT_INST
.CKB_VM_ASM_LABEL_OP_ADDI:
  DECODE_I
  ldr RS1, REGISTER_ADDRESS(RS1)
  add RS1, RS1, IMMEDIATE
  WRITE_RD(RS1)
  NEXT_INST
.CKB_VM_ASM_LABEL_OP_ADD:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ADDIW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ADDW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_AND:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ANDI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_AUIPC:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BEQ:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BGE:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BGEU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BLT:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BLTU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BNE:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_DIV:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_DIVU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_DIVUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_DIVW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_EBREAK:
  DECODE_U
  mov x0, CKB_VM_ASM_RET_EBREAK
  b .exit
.CKB_VM_ASM_LABEL_OP_ECALL:
  DECODE_U
  mov x0, CKB_VM_ASM_RET_ECALL
  b .exit
.CKB_VM_ASM_LABEL_OP_FENCE:
.CKB_VM_ASM_LABEL_OP_FENCEI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_JAL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_JALR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LB:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LBU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LD:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LH:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LHU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LUI:
.CKB_VM_ASM_LABEL_OP_CUSTOM_LOAD_IMM:
.CKB_VM_ASM_LABEL_OP_LD_SIGN_EXTENDED_32_CONSTANT:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_LWU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MUL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MULH:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MULHSU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MULHU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MULW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_OR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ORI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_REM:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_REMU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_REMUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_REMW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SB:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SD:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLLI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLLIW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLLW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLT:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLTI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLTIU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLTU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRA:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRAI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRAIW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRAW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRLI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRLIW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SRLW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SUB:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SUBW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_XOR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_XORI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ADDUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ANDN:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BCLR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BCLRI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BEXT:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BEXTI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BINV:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BINVI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BSET:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_BSETI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CLMUL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CLMULH:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CLMULR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CLZ:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CLZW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CPOP:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CPOPW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CTZ:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_CTZW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MAX:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MAXU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MIN:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_MINU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ORCB:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ORN:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_REV8:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ROL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ROLW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ROR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_RORI:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_RORIW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_RORW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SEXTB:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SEXTH:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH1ADD:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH1ADDUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH2ADD:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH2ADDUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH3ADD:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SH3ADDUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SLLIUW:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_XNOR:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ZEXTH:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_FAR_JUMP_ABS:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_FAR_JUMP_REL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_WIDE_MUL:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_WIDE_MULU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_WIDE_MULSU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_WIDE_DIV:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_WIDE_DIVU:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_ADC:
  UNIMPLEMENTED
.CKB_VM_ASM_LABEL_OP_SBB:
  UNIMPLEMENTED
.exit_max_cycles_exceeded:
  mov x0, CKB_VM_ASM_RET_MAX_CYCLES_EXCEEDED
  b .exit
.exit_cycles_overflow:
  mov x0, CKB_VM_ASM_RET_CYCLES_OVERFLOW
  b .exit
.exit_trace:
.CKB_VM_ASM_LABEL_OP_UNLOADED:
  DECODE_U
  mov x0, CKB_VM_ASM_RET_DECODE_TRACE
  b .exit
.exit_slowpath:
  DECODE_U
  mov x0, CKB_VM_ASM_RET_SLOWPATH
  b .exit
.exit:
  ldp x23, x24, [sp, 32]
  ldp x21, x22, [sp, 16]
  ldp x19, x20, [sp], 48
  ret
